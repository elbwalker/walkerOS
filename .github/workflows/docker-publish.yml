name: Docker Publish

on:
  push:
    tags:
      - '@walkeros/cli@*'
      - '@walkeros/docker@*'
  workflow_dispatch:
    inputs:
      images:
        description: 'Images to publish'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - cli
          - docker

env:
  REGISTRY: docker.io

jobs:
  publish-cli:
    if: >
      contains(github.ref, '@walkeros/cli@') ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.images != 'docker'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./packages/cli/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "CLI version: $VERSION"

      - name: Check if tag already exists
        id: check
        run: |
          if docker manifest inspect walkeros/cli:${{ steps.version.outputs.version }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è walkeros/cli:${{ steps.version.outputs.version }} already exists, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "üÜï walkeros/cli:${{ steps.version.outputs.version }} will be published"
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'false'
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Log in to Docker Hub
        if: steps.check.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build CLI
        if: steps.check.outputs.exists == 'false'
        run: |
          npm ci
          npm run build --workspace=@walkeros/cli

      - name: Build and push CLI image
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v5
        with:
          context: ./packages/cli
          file: ./packages/cli/docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            walkeros/cli:${{ steps.version.outputs.version }}
            walkeros/cli:latest
          cache-from: type=gha,scope=cli
          cache-to: type=gha,mode=max,scope=cli
          labels: |
            org.opencontainers.image.title=walkerOS CLI
            org.opencontainers.image.description=Build tool for bundling walkerOS flows
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT

      - name: Test CLI image
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Testing CLI help..."
          docker run --rm walkeros/cli:${{ steps.version.outputs.version }} --help
          echo "‚úÖ CLI image works"

  publish-docker:
    if: >
      contains(github.ref, '@walkeros/docker@') ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.images != 'cli'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./packages/docker/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Docker version: $VERSION"

      - name: Check if tag already exists
        id: check
        run: |
          if docker manifest inspect walkeros/docker:${{ steps.version.outputs.version }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è walkeros/docker:${{ steps.version.outputs.version }} already exists, skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "üÜï walkeros/docker:${{ steps.version.outputs.version }} will be published"
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'false'
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Log in to Docker Hub
        if: steps.check.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./packages/docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            walkeros/docker:${{ steps.version.outputs.version }}
            walkeros/docker:latest
          cache-from: type=gha,scope=docker
          cache-to: type=gha,mode=max,scope=docker
          labels: |
            org.opencontainers.image.title=walkerOS Docker
            org.opencontainers.image.description=Runtime Docker container for walkerOS with demo bundles
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT

      - name: Test Docker image
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Testing collect mode..."
          docker run --rm -d --name walker-test-collect \
            -e MODE=collect \
            -e FLOW=/app/demos/demo-collect.mjs \
            walkeros/docker:${{ steps.version.outputs.version }}

          sleep 5

          if docker ps | grep -q walker-test-collect; then
            echo "‚úÖ Collect mode started successfully"
            docker logs walker-test-collect
            docker stop walker-test-collect
          else
            echo "‚ùå Collect mode failed to start"
            docker logs walker-test-collect || true
            exit 1
          fi

          echo "Testing serve mode..."
          docker run --rm -d --name walker-test-serve \
            -e MODE=serve \
            -e FLOW=/app/demos/demo-serve.js \
            walkeros/docker:${{ steps.version.outputs.version }}

          sleep 5

          if docker ps | grep -q walker-test-serve; then
            echo "‚úÖ Serve mode started successfully"
            docker logs walker-test-serve
            docker stop walker-test-serve
          else
            echo "‚ùå Serve mode failed to start"
            docker logs walker-test-serve || true
            exit 1
          fi
