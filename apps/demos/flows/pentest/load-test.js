import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';

// Custom metrics
const failRate = new Rate('failed_requests');
const responseTime = new Trend('response_time_ms');

// Default options (can be overridden with --vus and --duration)
export const options = {
  stages: [
    { duration: '30s', target: 10 }, // Warm up
    { duration: '30s', target: 50 }, // Ramp to 50
    { duration: '1m', target: 100 }, // Push to 100
    { duration: '30s', target: 100 }, // Hold
    { duration: '30s', target: 0 }, // Ramp down
  ],
  thresholds: {
    http_req_duration: ['p(95)<2000'], // 95% under 2s
    failed_requests: ['rate<0.05'], // Less than 5% failures
  },
};

// Configurable endpoint (set via -e ENDPOINT=...)
const ENDPOINT =
  __ENV.ENDPOINT ||
  'https://walkeros-demo-589702085965.europe-west3.run.app/collect';

// Sample events to simulate real traffic
const events = [
  { name: 'page view', data: { title: 'Homepage', path: '/' } },
  { name: 'page view', data: { title: 'Product Page', path: '/products/1' } },
  { name: 'button click', data: { label: 'Add to Cart', product: 'SKU-001' } },
  {
    name: 'form submit',
    data: { form: 'newsletter', email: 'test@example.com' },
  },
  {
    name: 'product view',
    data: { id: 'SKU-001', name: 'walkerOS Pro', price: 299 },
  },
  { name: 'order complete', data: { orderId: 'ORD-12345', total: 299.99 } },
];

export default function () {
  // Pick a random event
  const event = events[Math.floor(Math.random() * events.length)];

  // Add timestamp and unique identifier
  const payload = JSON.stringify({
    ...event,
    timestamp: Date.now(),
    custom: { loadTest: true },
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
    },
  };

  const res = http.post(ENDPOINT, payload, params);

  // Track metrics
  responseTime.add(res.timings.duration);
  failRate.add(res.status !== 200);

  // Validate response
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 2000ms': (r) => r.timings.duration < 2000,
  });

  // Small delay between requests
  sleep(0.1);
}
