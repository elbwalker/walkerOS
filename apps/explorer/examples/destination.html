<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Destination Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        button:hover {
            background: #f0f0f0;
        }
        .btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .destination-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .destination-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .destination-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        .status-indicator.error {
            background: #dc3545;
        }
        .status-indicator.warning {
            background: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Destination Example</h1>
        <p>Manage and test data destinations for WalkerOS events with real-time monitoring.</p>
        
        <div id="destinations" style="min-height: 300px; border: 1px solid #ddd; border-radius: 4px; padding: 20px;"></div>
        
        <div class="controls">
            <button onclick="loadGA4Template()">Load GA4 Template</button>
            <button onclick="loadMetaTemplate()">Load Meta Pixel</button>
            <button onclick="loadGTMTemplate()">Load GTM Template</button>
            <button onclick="sendTestEvent()">Send Test Event</button>
            <button class="btn-primary" onclick="testDestination()">Test Destination</button>
            <button onclick="validateDestination()">Validate Config</button>
        </div>
    </div>

    <script src="../explorer.js"></script>
    <script>
        let destinationManager = null;
        let destinationCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            destinationManager = WalkerExplorer.createDestination('#destinations', {
                showTemplates: true,
                showTesting: true,
                enableValidation: true,
                height: '400px',
                onConfigChange: (config) => {
                    console.log('Destination config changed:', config.name);
                },
                onTest: (config, event) => {
                    console.log('Testing destination:', config.name, 'with event:', event.event);
                },
                onValidate: (config) => {
                    console.log('Validating destination:', config.name);
                    return []; // Return validation results
                }
            });
            
            window.destinationManager = destinationManager;
            
            // Load default GA4 template
            loadGA4Template();
        });

        window.loadGA4Template = () => {
            try {
                destinationManager.loadTemplate('ga4');
                console.log('‚úÖ Google Analytics 4 template loaded');
            } catch (error) {
                // Fallback: manually set GA4 config
                destinationManager.setConfig({
                    name: 'Google Analytics 4',
                    id: 'ga4_demo',
                    config: {
                        measurement_id: 'G-XXXXXXXXXX',
                        api_secret: '***hidden***',
                        debug_mode: true
                    },
                    init: 'console.log("Initializing GA4 destination");',
                    push: 'console.log("Pushing event to GA4:", event);'
                });
                console.log('‚úÖ Google Analytics 4 config set manually');
            }
        };

        window.loadMetaTemplate = () => {
            try {
                destinationManager.loadTemplate('meta');
                console.log('‚úÖ Meta Pixel template loaded');
            } catch (error) {
                // Fallback: manually set Meta config
                destinationManager.setConfig({
                    name: 'Meta Pixel',
                    id: 'meta_demo',
                    config: {
                        pixel_id: '123456789012345',
                        access_token: '***hidden***',
                        test_event_code: 'TEST12345'
                    },
                    init: 'console.log("Initializing Meta Pixel destination");',
                    push: 'console.log("Pushing event to Meta:", event);'
                });
                console.log('‚úÖ Meta Pixel config set manually');
            }
        };

        window.loadGTMTemplate = () => {
            try {
                destinationManager.loadTemplate('gtm');
                console.log('‚úÖ Google Tag Manager template loaded');
            } catch (error) {
                // Fallback: manually set GTM config
                destinationManager.setConfig({
                    name: 'Google Tag Manager',
                    id: 'gtm_demo',
                    config: {
                        container_id: 'GTM-XXXXXXX',
                        server_url: 'https://example.com/gtm',
                        preview_mode: false
                    },
                    init: 'console.log("Initializing GTM destination");',
                    push: 'console.log("Pushing to GTM dataLayer:", event);'
                });
                console.log('‚úÖ Google Tag Manager config set manually');
            }
        };

        window.sendTestEvent = () => {
            const testEvents = [
                {
                    event: 'product_view',
                    data: {
                        product_id: 'test_product_123',
                        product_name: 'Test Product',
                        category: 'electronics',
                        price: 99.99,
                        currency: 'USD'
                    }
                },
                {
                    event: 'add_to_cart',
                    data: {
                        product_id: 'test_product_123',
                        quantity: 2,
                        value: 199.98,
                        currency: 'USD'
                    }
                },
                {
                    event: 'page_view',
                    data: {
                        page_title: 'Destination Test Page',
                        page_location: window.location.href,
                        page_referrer: document.referrer
                    }
                }
            ];
            
            const randomEvent = testEvents[Math.floor(Math.random() * testEvents.length)];
            
            // Create test event in WalkerEvent format
            const walkerEvent = {
                event: randomEvent.event,
                data: randomEvent.data,
                timestamp: Date.now(),
                source: 'destination-demo'
            };
            
            console.log('Sending test event:', walkerEvent);
            // Note: This will show the event in console since we can't see the actual test results
        };

        window.testDestination = async () => {
            const testEvent = {
                event: 'test_connection',
                data: {
                    test_timestamp: Date.now(),
                    test_id: 'test_' + Math.random().toString(36).substr(2, 9),
                    value: 1.00,
                    currency: 'USD'
                },
                timestamp: Date.now(),
                source: 'destination-test'
            };
            
            try {
                console.log('Testing destination with event:', testEvent);
                const result = await destinationManager.testDestination(testEvent);
                console.log('‚úÖ Test completed:', result);
            } catch (error) {
                console.error('‚ùå Test failed:', error);
            }
        };

        window.validateDestination = () => {
            try {
                const results = destinationManager.validateConfig();
                console.log('Validation results:', results);
                
                if (results.length === 0) {
                    console.log('‚úÖ Configuration is valid');
                } else {
                    results.forEach(result => {
                        console.log(`${result.type.toUpperCase()}: ${result.message}`);
                    });
                }
            } catch (error) {
                console.error('‚ùå Validation failed:', error);
            }
        };
    </script>
</body>
</html>