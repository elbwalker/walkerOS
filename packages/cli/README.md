# @walkeros/cli

CLI tools for building, simulating, and deploying walkerOS event collection
systems.

## Overview

The walkerOS CLI provides three main commands:

- **`bundle`** - Generate JavaScript bundles from flow configurations
- **`simulate`** - Test event processing with simulated events
- **`run`** - Orchestrate Docker containers for deployment

## Installation

```bash
# Global installation (recommended for CLI usage)
npm install -g @walkeros/cli

# Local installation (for programmatic usage)
npm install @walkeros/cli
```

## Quick Start

```bash
# 1. Create a flow configuration
cat > flow.json <<EOF
{
  "flow": {
    "platform": "server",
    "sources": [{"name": "sourceExpress"}],
    "destinations": [{"name": "destinationConsole"}]
  },
  "build": {
    "packages": {},
    "code": "",
    "output": ""
  }
}
EOF

# 2. Generate a bundle
walkeros bundle flow.json

# 3. Simulate an event
walkeros simulate walker-bundle.js '{"name":"page view","data":{"title":"Test"}}'

# 4. Run in Docker (requires Docker image)
walkeros run collect flow.json --port 3000
```

## Commands

### bundle

Generate optimized JavaScript bundles from flow configurations.

**Usage:**

```bash
walkeros bundle <flowFile> [options]
```

**Arguments:**

- `flowFile` - Path to flow configuration JSON file

**Options:**

- `-o, --output <path>` - Output file path (default: `walker-bundle.js`)
- `--stats` - Show bundle statistics
- `--json` - Output in JSON format
- `-v, --verbose` - Verbose output

**Examples:**

```bash
# Basic bundle
walkeros bundle flow.json

# Custom output path
walkeros bundle flow.json --output dist/walker.js

# With statistics
walkeros bundle flow.json --stats
```

**Flow Configuration:**

```json
{
  "flow": {
    "platform": "server",
    "sources": [
      {
        "name": "sourceExpress"
      }
    ],
    "destinations": [
      {
        "name": "destinationConsole"
      }
    ]
  },
  "build": {
    "packages": {},
    "code": "",
    "output": ""
  }
}
```

### simulate

Simulate event processing for testing and debugging.

**Usage:**

```bash
walkeros simulate <bundleFile> <event> [options]
```

**Arguments:**

- `bundleFile` - Path to bundle file (generated by `bundle` command)
- `event` - Event JSON string to simulate

**Options:**

- `--json` - Output as JSON
- `-v, --verbose` - Verbose output

**Examples:**

```bash
# Page view event
walkeros simulate walker-bundle.js '{"name":"page view","data":{"title":"Home","path":"/"}}'

# Product view with nested data
walkeros simulate walker-bundle.js '{
  "name":"product view",
  "data":{"id":"P123","name":"Laptop","price":999.99},
  "context":{"category":["Electronics","Computers"]}
}'

# With verbose output
walkeros simulate walker-bundle.js '{"name":"button click","data":{"id":"cta"}}' --verbose
```

### run

Orchestrate Docker containers for deployment.

**Usage:**

```bash
walkeros run <mode> <file> [options]
```

**Arguments:**

- `mode` - Operation mode: `collect` or `serve`
- `file` - Flow config (collect mode) or static file (serve mode)

**Options:**

- `-p, --port <number>` - Port to expose (default: 8080)
- `-c, --container-name <name>` - Container name (default: auto-generated)
- `-i, --image <image>` - Docker image (default: `walkeros/docker:latest`)
- `--no-pull` - Skip pulling latest image

**Examples:**

```bash
# Collect mode - run event collection server
walkeros run collect flow.json --port 3000

# Serve mode - serve static bundle
walkeros run serve walker-bundle.js --port 8080

# Custom container name and image
walkeros run collect flow.json \
    --container-name my-walker \
    --image walkeros/docker:0.1.0 \
    --port 3000
```

**Signal Handling:** The run command handles signals gracefully:

- `Ctrl+C` (SIGINT) - Stop and cleanup container
- `SIGTERM` - Stop and cleanup container

The container is automatically removed on exit.

## Programmatic API

Use the CLI programmatically in Node.js applications:

```typescript
import { bundle, simulate, run } from '@walkeros/cli';
```

### bundle(options)

Generate a bundle programmatically.

```typescript
await bundle({
  flowFile: './flow.json',
  output: './dist/walker.js',
});
```

**Options:**

- `flowFile` (string) - Path to flow configuration
- `output` (string, optional) - Output path (default: `walker-bundle.js`)
- `stats` (boolean, optional) - Return statistics
- `json` (boolean, optional) - JSON output mode
- `verbose` (boolean, optional) - Verbose logging

### simulate(options)

Simulate event processing.

```typescript
await simulate({
  bundleFile: './walker-bundle.js',
  event: JSON.stringify({
    name: 'page view',
    data: { title: 'Test' },
  }),
});
```

**Options:**

- `bundleFile` (string) - Path to bundle file
- `event` (string) - Event JSON string
- `json` (boolean, optional) - JSON output mode
- `verbose` (boolean, optional) - Verbose logging

### run(options)

Orchestrate Docker container.

```typescript
await run({
  mode: 'collect',
  flowFile: './flow.json',
  port: 3000,
  containerName: 'my-walker',
  image: 'walkeros/docker:latest',
});
```

**Options:**

- `mode` (string) - `collect` or `serve`
- `flowFile` (string) - Flow configuration path (collect mode)
- `staticFile` (string) - Static file path (serve mode)
- `port` (number, optional) - Port to expose (default: 8080)
- `containerName` (string, optional) - Container name
- `image` (string, optional) - Docker image (default: `walkeros/docker:latest`)
- `pull` (boolean, optional) - Pull latest image (default: true)

## Examples

### Example 1: Build and Test Workflow

```bash
# Create flow
cat > ecommerce-flow.json <<EOF
{
  "flow": {
    "platform": "server",
    "sources": [{"name": "sourceExpress"}],
    "destinations": [{"name": "destinationConsole"}]
  },
  "build": {
    "packages": {},
    "code": "",
    "output": ""
  }
}
EOF

# Bundle
walkeros bundle ecommerce-flow.json --output ecommerce-walker.js

# Test with simulation
walkeros simulate ecommerce-walker.js '{
  "name": "product view",
  "data": {"id": "P123", "name": "Laptop", "price": 999}
}'

walkeros simulate ecommerce-walker.js '{
  "name": "order complete",
  "data": {"id": "O456", "total": 999, "items": 1}
}'
```

### Example 2: Docker Deployment

```bash
# Run in Docker (development)
walkeros run collect ecommerce-flow.json --port 3000

# In another terminal, test the server
curl http://localhost:3000/health
curl -X POST http://localhost:3000/collect \
    -H "Content-Type: application/json" \
    -d '{"name":"page view","data":{"title":"Home"}}'
```

### Example 3: Programmatic Integration

```typescript
import { bundle, simulate } from '@walkeros/cli';
import { writeFileSync } from 'fs';

// Create flow config
const flowConfig = {
  flow: {
    platform: 'server',
    sources: [{ name: 'sourceExpress' }],
    destinations: [{ name: 'destinationConsole' }],
  },
  build: {
    packages: {},
    code: '',
    output: '',
  },
};

writeFileSync('flow.json', JSON.stringify(flowConfig, null, 2));

// Bundle
await bundle({
  flowFile: 'flow.json',
  output: 'walker.js',
});

// Simulate multiple events
const events = [
  { name: 'page view', data: { path: '/' } },
  { name: 'button click', data: { id: 'cta' } },
  { name: 'form submit', data: { form: 'newsletter' } },
];

for (const event of events) {
  await simulate({
    bundleFile: 'walker.js',
    event: JSON.stringify(event),
  });
}
```

## Demos

Interactive demonstrations available in the `demos/` directory:

```bash
# Run the quick demo (5 minutes)
./demos/quick-demo.sh

# Run programmatic examples
node demos/programmatic-example.js
```

See [demos/README.md](./demos/README.md) for more examples.

## Documentation

Comprehensive guides available in `docs/`:

- **[RUN_COMMAND.md](./docs/RUN_COMMAND.md)** - Detailed run command
  documentation
- **[PUBLISHING.md](./docs/PUBLISHING.md)** - Publishing and deployment guide
- **[MANUAL_TESTING_GUIDE.md](./docs/MANUAL_TESTING_GUIDE.md)** - Step-by-step
  testing instructions

## Architecture

```
@walkeros/cli
├── bundle/         Bundle generation
│   ├── bundler.ts       - Main bundler logic
│   ├── serializer.ts    - Code serialization
│   └── templates/       - Handlebars templates
├── simulate/       Event simulation
│   └── simulator.ts     - Event processing simulator
├── run/            Docker orchestration
│   ├── orchestrator.ts  - Container management
│   ├── docker-manager.ts- Docker CLI wrapper
│   └── validators.ts    - Input validation
└── core/           Shared utilities
    ├── logger.ts        - Logging system
    ├── timer.ts         - Performance timing
    └── output.ts        - Output formatting
```

## Requirements

- **Node.js**: 18+ or 22+ (recommended)
- **Docker**: Required for `run` command
- **Operating System**: Linux, macOS, Windows (with WSL2 for Docker)

## Related Packages

- **[@walkeros/docker](../docker/README.md)** - Docker runtime container
- **[@walkeros/core](../core/README.md)** - Core utilities
- **[@walkeros/collector](../collector/README.md)** - Event collection engine

## Support

- **GitHub Issues**: https://github.com/elbwalker/walkerOS/issues
- **Documentation**: https://github.com/elbwalker/walkerOS#readme
- **Discord**: (community link)

## License

MIT © elbwalker
