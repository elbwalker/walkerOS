(async () => {
  // Check if we're in a browser environment
  const window = typeof globalThis.window !== 'undefined' ? globalThis.window : undefined;
  const document = typeof globalThis.document !== 'undefined' ? globalThis.document : undefined;

  const config = {
    sources: {
    {{#each sources}}
      {{@key}}: {
        code: {{{code}}},
        config: {{{config}}}{{#unless config}}{}{{/unless}}{{#if env}},
        env: {
          window,
          document,
          ...{{{env}}}
        }{{/if}}
      }{{#unless @last}},{{/unless}}
    {{/each}}
    },
    destinations: {
    {{#each destinations}}
      {{@key}}: {
        code: {{{code}}},
        config: {{{config}}}{{#unless config}}{}{{/unless}}{{#if env}},
        env: {
          window,
          document,
          ...{{{env}}}
        }{{/if}}
      }{{#unless @last}},{{/unless}}
    {{/each}}
    }{{#if collector}},
    ...{{{collector}}}{{/if}}
  };

  {{{CODE}}}

  const { collector, elb } = await startFlow(config);

  if (typeof window !== 'undefined') {
    {{#if build.windowCollector}}window['{{build.windowCollector}}'] = collector;
    {{/if}}{{#if build.windowElb}}window['{{build.windowElb}}'] = elb;
    {{/if}}
  }
})();
