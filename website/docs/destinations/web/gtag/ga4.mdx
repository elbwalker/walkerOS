---
title: Google Analytics 4 (GA4)
description: Google Analytics 4 configuration within the unified gtag destination
sidebar_position: 2
---

# Google Analytics 4 (GA4)

Configure Google Analytics 4 within the unified gtag destination for advanced web analytics, user behavior tracking, and comprehensive reporting.

## Configuration

### Basic Setup

```typescript
import { destinationGtag } from '@walkerOS/web-destination-gtag';

const destination = destinationGtag({
  settings: {
    ga4: {
      measurementId: 'G-XXXXXXXXXX', // Required
      debug: false,
      pageview: true,
      snakeCase: true,
    },
  },
});
```

### Advanced Configuration

```typescript
const destination = destinationGtag({
  settings: {
    ga4: {
      measurementId: 'G-XXXXXXXXXX',
      debug: process.env.NODE_ENV === 'development',
      include: ['data', 'context', 'user'],
      pageview: false, // Disable automatic pageviews
      snakeCase: true, // Convert event names to snake_case
      transport_url: 'https://custom-analytics.example.com/collect',
      server_container_url: 'https://gtm-server.example.com',
    },
  },
});
```

## GA4 Settings Reference

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `measurementId` | `string` | **Required** | GA4 Measurement ID (G-XXXXXXXXXX) |
| `debug` | `boolean` | `false` | Enable debug mode for DebugView |
| `include` | `Include[]` | `['data']` | Data groups to include in events |
| `pageview` | `boolean` | `true` | Send automatic pageview events |
| `snakeCase` | `boolean` | `true` | Convert event names to snake_case |
| `transport_url` | `string` | `undefined` | Custom measurement endpoint |
| `server_container_url` | `string` | `undefined` | Server-side GTM endpoint |

### Include Options

The `include` setting controls which data groups are sent with events:

- `'all'` - Include all available data groups
- `'context'` - Page context (URL, referrer, etc.)
- `'data'` - Event-specific data
- `'event'` - Event metadata (ID, timing, trigger)
- `'globals'` - Global properties
- `'source'` - Source information
- `'user'` - User properties
- `'version'` - WalkerOS version info

## Event Mapping

### GA4-Specific Mapping

```typescript
const mapping = {
  order: {
    complete: {
      name: 'purchase',
      settings: {
        ga4: {
          include: ['data', 'context', 'user'], // GA4-specific includes
        },
      },
      data: {
        map: {
          transaction_id: 'data.id',
          value: 'data.total',
          tax: 'data.taxes',
          shipping: 'data.shipping',
          currency: { key: 'data.currency', value: 'EUR' },
          items: {
            loop: [
              'nested',
              {
                condition: (entity) => entity.type === 'product',
                map: {
                  item_id: 'data.id',
                  item_name: 'data.name',
                  item_category: 'data.category',
                  item_brand: 'data.brand',
                  quantity: { key: 'data.quantity', value: 1 },
                  price: 'data.price',
                },
              },
            ],
          },
        },
      },
    },
  },
};
```

## Enhanced Ecommerce Events

### Purchase Event

```typescript
// Mapping for purchase events
const purchaseMapping = {
  name: 'purchase',
  settings: {
    ga4: {
      include: ['data', 'context'],
    },
  },
  data: {
    map: {
      transaction_id: 'data.id',
      value: 'data.total',
      tax: 'data.taxes',
      shipping: 'data.shipping',
      currency: 'data.currency',
      coupon: 'data.coupon',
      items: {
        loop: [
          'nested',
          {
            condition: (entity) => entity.type === 'product',
            map: {
              item_id: 'data.id',
              item_name: 'data.name',
              item_category: 'data.category',
              item_category2: 'data.subcategory',
              item_brand: 'data.brand',
              item_variant: 'data.variant',
              quantity: 'data.quantity',
              price: 'data.price',
              index: 'data.position',
            },
          },
        ],
      },
    },
  },
};
```

### Add to Cart Event

```typescript
const addToCartMapping = {
  name: 'add_to_cart',
  settings: {
    ga4: {
      include: ['data'],
    },
  },
  data: {
    map: {
      currency: { value: 'EUR', key: 'data.currency' },
      value: 'data.price',
      items: {
        loop: [
          'this',
          {
            map: {
              item_id: 'data.id',
              item_name: 'data.name',
              item_category: 'data.category',
              item_brand: 'data.brand',
              item_variant: 'data.color',
              quantity: { value: 1, key: 'data.quantity' },
              price: 'data.price',
            },
          },
        ],
      },
    },
  },
};
```

### View Item Event

```typescript
const viewItemMapping = {
  name: 'view_item',
  settings: {
    ga4: {
      include: ['data', 'context'],
    },
  },
  data: {
    map: {
      item_id: 'data.id',
      item_name: 'data.name',
      item_category: 'data.category',
      item_brand: 'data.brand',
      value: 'data.price',
      currency: 'data.currency',
    },
  },
};
```

## Custom Parameters

### User Properties

Set custom user properties for enhanced user analysis:

```typescript
// Set user properties via data mapping
const userPropertiesMapping = {
  data: {
    map: {
      // Custom user properties (prefixed with user_)
      user_subscription_type: 'user.subscription',
      user_loyalty_level: 'user.loyalty',
      user_first_visit_date: 'user.firstVisit',
      
      // Custom parameters for this event
      custom_campaign: 'context.campaign',
      custom_source: 'context.source',
    },
  },
};
```

### Event Parameters

Add custom event parameters:

```typescript
const customEventMapping = {
  name: 'custom_action',
  settings: {
    ga4: {
      include: ['data', 'user'],
    },
  },
  data: {
    map: {
      // Standard parameters
      event_category: { value: 'engagement' },
      event_label: 'data.label',
      value: 'data.value',
      
      // Custom parameters
      custom_dimension_1: 'data.customField',
      custom_metric_1: 'data.score',
    },
  },
};
```

## Debug Mode

Enable debug mode to see events in GA4 DebugView:

```typescript
const destination = destinationGtag({
  settings: {
    ga4: {
      measurementId: 'G-XXXXXXXXXX',
      debug: true, // Enable debug mode
    },
  },
});
```

When debug mode is enabled:
- Events appear in GA4 DebugView in real-time
- Additional debugging information is included
- Events are marked with `debug_mode: true`

## Server-Side Configuration

### Custom Transport URL

Send data to a custom measurement endpoint:

```typescript
const destination = destinationGtag({
  settings: {
    ga4: {
      measurementId: 'G-XXXXXXXXXX',
      transport_url: 'https://analytics-proxy.example.com/collect',
    },
  },
});
```

### Server-Side GTM

Use with server-side Google Tag Manager:

```typescript
const destination = destinationGtag({
  settings: {
    ga4: {
      measurementId: 'G-XXXXXXXXXX',
      server_container_url: 'https://gtm-server.example.com',
    },
  },
});
```

## Best Practices

### 1. Event Naming
- Use descriptive, consistent event names
- Enable `snakeCase: true` for GA4 conventions
- Follow GA4's recommended event naming patterns

### 2. Data Inclusion
- Use `include: ['data']` for most events to minimize payload
- Add `'context'` for page-related events
- Add `'user'` for events needing user properties

### 3. Enhanced Ecommerce
- Always include `transaction_id` for purchase events
- Use proper item structure with all required fields
- Include `currency` and `value` for monetary events

### 4. Custom Parameters
- Prefix custom user properties with `user_`
- Use descriptive parameter names
- Avoid sending sensitive information

### 5. Performance
- Disable automatic pageviews if implementing custom page tracking
- Use appropriate `include` settings to minimize data sent
- Consider using server-side GTM for better performance

## Troubleshooting

### Events Not Appearing in GA4

1. **Check Measurement ID**: Ensure the measurement ID is correct
2. **Enable Debug Mode**: Use debug mode to see events in DebugView
3. **Verify Event Structure**: Check that required parameters are included
4. **Check Filters**: Ensure GA4 filters aren't excluding events

### DebugView Not Working

1. **Enable Debug Mode**: Set `debug: true` in GA4 settings
2. **Check Browser**: DebugView works best in Chrome/Firefox
3. **Verify Measurement ID**: Ensure you're viewing the correct property
4. **Clear Cache**: Clear browser cache and cookies

### Custom Parameters Not Showing

1. **Register Custom Dimensions**: Create custom dimensions in GA4 interface
2. **Wait for Processing**: Custom parameters may take time to appear
3. **Check Parameter Names**: Ensure parameter names follow GA4 conventions
4. **Verify Data Type**: Ensure parameter values are the correct data type

## TypeScript Support

Full TypeScript support with proper typing:

```typescript
import type { DestinationGtag } from '@walkerOS/web-destination-gtag';

// Type-safe GA4 configuration
const ga4Config: DestinationGtag.GA4Settings = {
  measurementId: 'G-XXXXXXXXXX',
  debug: true,
  include: ['data', 'context'],
  snakeCase: true,
};

// Type-safe mapping rules
const ga4Mapping: DestinationGtag.GA4Mapping = {
  include: ['data', 'user'],
};
```