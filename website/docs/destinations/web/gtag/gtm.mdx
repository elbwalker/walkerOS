---
title: Google Tag Manager (GTM)
description: Google Tag Manager configuration within the unified gtag destination
sidebar_position: 4
---

# Google Tag Manager (GTM)

Configure Google Tag Manager within the unified gtag destination for flexible tag management, custom tracking implementations, and advanced analytics workflows.

## Configuration

### Basic Setup

```typescript
import { destinationGtag } from '@walkerOS/web-destination-gtag';

const destination = destinationGtag({
  settings: {
    gtm: {
      containerId: 'GTM-XXXXXXX', // Required
    },
  },
});
```

### Advanced Configuration

```typescript
const destination = destinationGtag({
  settings: {
    gtm: {
      containerId: 'GTM-XXXXXXX',
      dataLayer: 'customDataLayer', // Custom dataLayer name
      domain: 'gtm.example.com', // Custom GTM domain
    },
  },
});
```

## GTM Settings Reference

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `containerId` | `string` | **Required** | GTM Container ID (GTM-XXXXXXX) |
| `dataLayer` | `string` | `'dataLayer'` | Custom dataLayer name |
| `domain` | `string` | `undefined` | Custom GTM domain for server-side GTM |

## DataLayer Events

### How GTM Integration Works

The GTM integration pushes structured event data to the configured dataLayer:

```typescript
// This walkerOS event...
elb('order complete', {
  id: 'order-123',
  total: 99.99,
  currency: 'USD',
});

// ...becomes this dataLayer push:
window.dataLayer.push({
  event: 'order_complete', // Event name (snake_case)
  event_data: {
    id: 'order-123',
    total: 99.99,
    currency: 'USD',
  },
  // Additional walkerOS context data...
});
```

### Event Structure

GTM receives events with this structure:

```typescript
interface GTMEvent {
  event: string;           // Event name in snake_case
  event_data: object;      // Mapped event data
  event_context?: object;  // Page context (if included)
  event_user?: object;     // User properties (if included)
  event_globals?: object;  // Global properties (if included)
  event_source?: object;   // Source information (if included)
  event_version?: string;  // WalkerOS version (if included)
}
```

## Event Mapping

### Basic Event Mapping

```typescript
const mapping = {
  product: {
    view: {
      name: 'view_item',
      settings: {
        gtm: {}, // Send to GTM with default settings
      },
      data: {
        map: {
          item_id: 'data.id',
          item_name: 'data.name',
          item_category: 'data.category',
          value: 'data.price',
          currency: 'data.currency',
        },
      },
    },
  },
};
```

This creates a dataLayer event:

```javascript
window.dataLayer.push({
  event: 'view_item',
  event_data: {
    item_id: 'product-123',
    item_name: 'Premium Widget',
    item_category: 'Electronics',
    value: 29.99,
    currency: 'USD',
  },
});
```

### E-commerce Event Mapping

```typescript
const ecommerceMapping = {
  order: {
    complete: {
      name: 'purchase',
      settings: {
        gtm: {},
      },
      data: {
        map: {
          transaction_id: 'data.id',
          value: 'data.total',
          tax: 'data.taxes',
          shipping: 'data.shipping',
          currency: 'data.currency',
          coupon: 'data.coupon',
          items: {
            loop: [
              'nested',
              {
                condition: (entity) => entity.type === 'product',
                map: {
                  item_id: 'data.id',
                  item_name: 'data.name',
                  item_category: 'data.category',
                  item_brand: 'data.brand',
                  item_variant: 'data.variant',
                  quantity: 'data.quantity',
                  price: 'data.price',
                },
              },
            ],
          },
        },
      },
    },
  },
};
```

DataLayer output:

```javascript
window.dataLayer.push({
  event: 'purchase',
  event_data: {
    transaction_id: 'order-456',
    value: 149.97,
    tax: 12.00,
    shipping: 5.99,
    currency: 'USD',
    coupon: 'SUMMER20',
    items: [
      {
        item_id: 'widget-123',
        item_name: 'Premium Widget',
        item_category: 'Electronics',
        item_brand: 'WidgetCorp',
        quantity: 2,
        price: 29.99,
      },
      // More items...
    ],
  },
});
```

## Custom DataLayer

### Using Custom DataLayer Name

Configure a custom dataLayer name for multiple GTM containers or custom implementations:

```typescript
const destination = destinationGtag({
  settings: {
    gtm: {
      containerId: 'GTM-XXXXXXX',
      dataLayer: 'myCustomDataLayer', // Custom name
    },
  },
});
```

This pushes events to `window.myCustomDataLayer` instead of the default `window.dataLayer`.

### Multiple GTM Containers

Use multiple gtag destinations for different GTM containers:

```typescript
import { collector } from '@walkerOS/collector';
import { destinationGtag } from '@walkerOS/web-destination-gtag';

const instance = collector({
  destinations: [
    // Main GTM container
    destinationGtag({
      settings: {
        gtm: {
          containerId: 'GTM-MAIN123',
          dataLayer: 'dataLayer',
        },
      },
    }),
    // Secondary GTM container
    destinationGtag({
      settings: {
        gtm: {
          containerId: 'GTM-SEC456',
          dataLayer: 'secondaryDataLayer',
        },
      },
    }),
  ],
});
```

## GTM Tag Configuration

### Setting Up Tags in GTM

1. **Create Custom Event Trigger**:
   - Trigger Type: Custom Event
   - Event Name: `view_item` (or your mapped event name)

2. **Create Variables for Event Data**:
   ```javascript
   // Data Layer Variable for item_id
   Variable Type: Data Layer Variable
   Data Layer Variable Name: event_data.item_id
   
   // Data Layer Variable for value
   Variable Type: Data Layer Variable
   Data Layer Variable Name: event_data.value
   ```

3. **Configure Tags**:
   - Use the created variables in your tags (GA4, Google Ads, etc.)
   - Reference event data using `{{event_data.field_name}}`

### GA4 Tag Example in GTM

```javascript
// GA4 Configuration Tag
Tag Type: Google Analytics: GA4 Configuration
Measurement ID: G-XXXXXXXXXX

// GA4 Event Tag
Tag Type: Google Analytics: GA4 Event
Configuration Tag: [Your GA4 Configuration Tag]
Event Name: {{Event}} // Uses the 'event' field from dataLayer
Custom Parameters:
  - item_id: {{event_data.item_id}}
  - value: {{event_data.value}}
  - currency: {{event_data.currency}}

Trigger: Custom Event (event name: view_item)
```

## Server-Side GTM

### Configuration for Server-Side GTM

```typescript
const destination = destinationGtag({
  settings: {
    gtm: {
      containerId: 'GTM-XXXXXXX',
      domain: 'gtm-server.example.com', // Your server-side GTM domain
    },
  },
});
```

### Benefits of Server-Side GTM

- **Enhanced Privacy**: Data processing on your server
- **Better Performance**: Reduced client-side JavaScript
- **Data Control**: Full control over data before sending to third parties
- **Compliance**: Easier GDPR/CCPA compliance

## Advanced Use Cases

### Custom Event Parameters

Add custom parameters to GTM events:

```typescript
const customMapping = {
  user: {
    signup: {
      name: 'user_signup',
      settings: {
        gtm: {},
      },
      data: {
        map: {
          // Standard parameters
          user_id: 'user.id',
          method: 'data.method',
          
          // Custom parameters
          signup_source: 'context.source',
          referrer_domain: 'context.referrer',
          page_category: { value: 'registration' },
          
          // User properties
          user_type: 'user.type',
          account_age_days: 'user.accountAge',
        },
      },
    },
  },
};
```

### Conditional Event Sending

Send events to GTM only under certain conditions:

```typescript
const conditionalMapping = {
  product: {
    view: {
      name: 'view_item',
      settings: {
        gtm: {},
      },
      data: {
        condition: (event) => {
          // Only send to GTM for premium products
          return event.data.category === 'premium';
        },
        map: {
          item_id: 'data.id',
          item_name: 'data.name',
          item_category: 'data.category',
          value: 'data.price',
        },
      },
    },
  },
};
```

### Enhanced E-commerce with Custom Fields

```typescript
const enhancedEcommerceMapping = {
  order: {
    complete: {
      name: 'purchase',
      settings: {
        gtm: {},
      },
      data: {
        map: {
          // Standard e-commerce fields
          transaction_id: 'data.id',
          value: 'data.total',
          currency: 'data.currency',
          
          // Custom business fields
          payment_method: 'data.paymentMethod',
          delivery_option: 'data.deliveryOption',
          customer_type: 'user.type',
          loyalty_points_earned: 'data.loyaltyPoints',
          
          // Attribution data
          campaign_source: 'context.utm_source',
          campaign_medium: 'context.utm_medium',
          campaign_name: 'context.utm_campaign',
          
          // Items with custom fields
          items: {
            loop: [
              'nested',
              {
                condition: (entity) => entity.type === 'product',
                map: {
                  item_id: 'data.id',
                  item_name: 'data.name',
                  item_category: 'data.category',
                  item_brand: 'data.brand',
                  quantity: 'data.quantity',
                  price: 'data.price',
                  
                  // Custom item fields
                  item_supplier: 'data.supplier',
                  item_margin: 'data.margin',
                  item_weight: 'data.weight',
                },
              },
            ],
          },
        },
      },
    },
  },
};
```

## Combined with Other Tools

### GTM + GA4 + Google Ads

Use GTM alongside other Google tools in the same destination:

```typescript
const unifiedTracking = {
  order: {
    complete: {
      name: 'purchase',
      settings: {
        ga4: {
          include: ['data', 'context'],
        },
        ads: {}, // Direct conversion tracking
        gtm: {}, // Additional GTM processing
      },
      data: {
        map: {
          // Shared data for all tools
          transaction_id: 'data.id',
          value: 'data.total',
          currency: 'data.currency',
          
          // GA4 enhanced e-commerce
          items: {
            loop: [
              'nested',
              {
                condition: (entity) => entity.type === 'product',
                map: {
                  item_id: 'data.id',
                  item_name: 'data.name',
                  quantity: 'data.quantity',
                  price: 'data.price',
                },
              },
            ],
          },
          
          // GTM gets additional context
          customer_lifetime_value: 'user.lifetimeValue',
          order_source: 'context.source',
        },
      },
    },
  },
};
```

## Debugging GTM Integration

### GTM Preview Mode

1. **Enable Preview Mode** in your GTM container
2. **Refresh your page** with the GTM preview banner
3. **Trigger events** and observe them in the preview panel
4. **Check dataLayer** tab to see pushed events

### Browser Developer Tools

```javascript
// Check dataLayer contents
console.log(window.dataLayer);

// Monitor dataLayer pushes
const originalPush = window.dataLayer.push;
window.dataLayer.push = function(...args) {
  console.log('DataLayer push:', args);
  return originalPush.apply(this, args);
};
```

### GTM Debug Variables

Create debug variables in GTM:

```javascript
// Debug Variable for Full Event Data
Variable Type: Data Layer Variable
Data Layer Variable Name: event_data
Default Value: {}

// Debug Variable for Event Name
Variable Type: Data Layer Variable  
Data Layer Variable Name: event
Default Value: 'unknown'
```

## Troubleshooting

### Events Not Appearing in GTM

1. **Check Container ID**: Verify the GTM container ID is correct
2. **Verify DataLayer**: Check `window.dataLayer` in browser console
3. **GTM Preview Mode**: Use GTM preview to debug event flow
4. **Tag Firing**: Ensure triggers match your event names

### DataLayer Structure Issues

1. **Event Names**: Ensure event names match your GTM triggers
2. **Data Structure**: Verify event_data contains expected fields
3. **DataLayer Name**: Check custom dataLayer name configuration
4. **Timing**: Ensure GTM loads before events are fired

### Server-Side GTM Not Working

1. **Domain Configuration**: Verify server-side GTM domain
2. **Container Setup**: Ensure server container is properly configured
3. **Network Issues**: Check for CORS or firewall blocking
4. **SSL/TLS**: Ensure proper HTTPS configuration

## Best Practices

### 1. Event Naming
- Use consistent, descriptive event names
- Follow snake_case convention for GTM compatibility
- Align with GA4 recommended events when possible

### 2. Data Structure
- Keep event_data flat when possible
- Use consistent field names across events
- Include relevant context for better attribution

### 3. GTM Organization
- Use folders to organize tags by tool/purpose
- Create reusable variables for common data fields
- Document your GTM setup for team collaboration

### 4. Performance
- Minimize dataLayer payload size
- Use GTM's built-in debugging tools
- Monitor tag firing performance

### 5. Privacy & Compliance
- Ensure proper consent management
- Avoid sending PII in clear text
- Use server-side GTM for sensitive data processing

## TypeScript Support

```typescript
import type { DestinationGtag } from '@walkerOS/web-destination-gtag';

// Type-safe GTM configuration
const gtmConfig: DestinationGtag.GTMSettings = {
  containerId: 'GTM-XXXXXXX',
  dataLayer: 'dataLayer',
  domain: 'gtm.example.com',
};

// Type-safe mapping
const gtmMapping: DestinationGtag.GTMMapping = {
  // GTM specific mapping options
};
```