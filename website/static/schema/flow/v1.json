{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$ref": "#/definitions/FlowSetup",
  "definitions": {
    "Primitive": {
      "type": ["string", "number", "boolean"],
      "description": "Primitive value: string, number, or boolean"
    },
    "Variables": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/Primitive"
      },
      "description": "Variables for interpolation"
    },
    "Definitions": {
      "type": "object",
      "additionalProperties": {},
      "description": "Reusable configuration definitions"
    },
    "InlineCode": {
      "type": "object",
      "properties": {
        "push": {
          "type": "string",
          "description": "Push function with $code: prefix (required)"
        },
        "type": {
          "type": "string",
          "description": "Optional instance type identifier"
        },
        "init": {
          "type": "string",
          "description": "Optional init function with $code: prefix"
        }
      },
      "required": ["push"],
      "additionalProperties": false,
      "description": "Inline code definition for sources/destinations/transformers"
    },
    "PackageConfig": {
      "type": "object",
      "properties": {
        "version": {
          "type": "string",
          "description": "Package version to use"
        },
        "imports": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Named exports to import from the package"
        },
        "path": {
          "type": "string",
          "description": "Local path (takes precedence over version)"
        }
      },
      "additionalProperties": false
    },
    "Packages": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/PackageConfig"
      },
      "description": "NPM packages to bundle"
    },
    "WebConfig": {
      "type": "object",
      "properties": {
        "windowCollector": {
          "type": "string",
          "description": "Window property name for collector instance (default: \"collector\")"
        },
        "windowElb": {
          "type": "string",
          "description": "Window property name for elb function (default: \"elb\")"
        }
      },
      "additionalProperties": false,
      "description": "Web platform configuration"
    },
    "ServerConfig": {
      "type": "object",
      "additionalProperties": true,
      "description": "Server platform configuration (reserved for future options)"
    },
    "SourceReference": {
      "type": "object",
      "properties": {
        "package": {
          "type": "string",
          "minLength": 1,
          "description": "Package specifier with optional version (e.g., \"@walkeros/web-source-browser@2.0.0\")"
        },
        "code": {
          "oneOf": [
            {
              "type": "string",
              "description": "Named export to use from the package"
            },
            {
              "$ref": "#/definitions/InlineCode",
              "description": "Inline code definition (use instead of package)"
            }
          ],
          "description": "Either a named export string (with package) or an InlineCode object (without package)"
        },
        "config": {
          "description": "Source-specific configuration object"
        },
        "env": {
          "description": "Source environment configuration"
        },
        "primary": {
          "type": "boolean",
          "description": "Mark as primary source (provides main elb). Only one source should be primary."
        },
        "next": {
          "type": "string",
          "description": "Next transformer in chain (pre-collector processing)"
        },
        "variables": {
          "$ref": "#/definitions/Variables",
          "description": "Source-level variables (highest priority in cascade)"
        },
        "definitions": {
          "$ref": "#/definitions/Definitions",
          "description": "Source-level definitions (highest priority in cascade)"
        }
      },
      "additionalProperties": false,
      "oneOf": [
        {
          "required": ["package"],
          "properties": { "code": false }
        },
        {
          "required": ["code"],
          "properties": { "package": false }
        }
      ],
      "description": "Source reference - use either 'package' or 'code' object, not both"
    },
    "DestinationReference": {
      "type": "object",
      "properties": {
        "package": {
          "type": "string",
          "minLength": 1,
          "description": "Package specifier with optional version (e.g., \"@walkeros/web-destination-gtag@2.0.0\")"
        },
        "code": {
          "oneOf": [
            {
              "type": "string",
              "description": "Named export to use from the package"
            },
            {
              "$ref": "#/definitions/InlineCode",
              "description": "Inline code definition (use instead of package)"
            }
          ],
          "description": "Either a named export string (with package) or an InlineCode object (without package)"
        },
        "config": {
          "description": "Destination-specific configuration object"
        },
        "env": {
          "description": "Destination environment configuration"
        },
        "before": {
          "type": "string",
          "description": "Transformer to run before this destination (post-collector processing)"
        },
        "variables": {
          "$ref": "#/definitions/Variables",
          "description": "Destination-level variables (highest priority in cascade)"
        },
        "definitions": {
          "$ref": "#/definitions/Definitions",
          "description": "Destination-level definitions (highest priority in cascade)"
        }
      },
      "additionalProperties": false,
      "oneOf": [
        {
          "required": ["package"],
          "properties": { "code": false }
        },
        {
          "required": ["code"],
          "properties": { "package": false }
        }
      ],
      "description": "Destination reference - use either 'package' or 'code' object, not both"
    },
    "TransformerReference": {
      "type": "object",
      "properties": {
        "package": {
          "type": "string",
          "minLength": 1,
          "description": "Package specifier with optional version (e.g., \"@walkeros/transformer-validator@1.0.0\")"
        },
        "code": {
          "oneOf": [
            {
              "type": "string",
              "description": "Named export to use from the package"
            },
            {
              "$ref": "#/definitions/InlineCode",
              "description": "Inline code definition (use instead of package)"
            }
          ],
          "description": "Either a named export string (with package) or an InlineCode object (without package)"
        },
        "config": {
          "description": "Transformer-specific configuration object"
        },
        "env": {
          "description": "Transformer environment configuration"
        },
        "next": {
          "type": "string",
          "description": "Next transformer in chain (omit to end chain)"
        },
        "variables": {
          "$ref": "#/definitions/Variables",
          "description": "Transformer-level variables (highest priority in cascade)"
        },
        "definitions": {
          "$ref": "#/definitions/Definitions",
          "description": "Transformer-level definitions (highest priority in cascade)"
        }
      },
      "additionalProperties": false,
      "oneOf": [
        {
          "required": ["package"],
          "properties": { "code": false }
        },
        {
          "required": ["code"],
          "properties": { "package": false }
        }
      ],
      "description": "Transformer reference - use either 'package' or 'code' object, not both"
    },
    "FlowConfig": {
      "type": "object",
      "properties": {
        "web": {
          "$ref": "#/definitions/WebConfig",
          "description": "Web platform configuration (browser-based tracking). Mutually exclusive with server."
        },
        "server": {
          "$ref": "#/definitions/ServerConfig",
          "description": "Server platform configuration (Node.js). Mutually exclusive with web."
        },
        "sources": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/SourceReference"
          },
          "description": "Source configurations (data capture) keyed by unique identifier"
        },
        "destinations": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/DestinationReference"
          },
          "description": "Destination configurations (data output) keyed by unique identifier"
        },
        "transformers": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/TransformerReference"
          },
          "description": "Transformer configurations (event processing) keyed by unique identifier"
        },
        "collector": {
          "description": "Collector configuration for event processing (uses Collector.InitConfig)"
        },
        "packages": {
          "$ref": "#/definitions/Packages",
          "description": "NPM packages to bundle"
        },
        "variables": {
          "$ref": "#/definitions/Variables",
          "description": "Flow-level variables (override Setup.variables, overridden by source/destination variables)"
        },
        "definitions": {
          "$ref": "#/definitions/Definitions",
          "description": "Flow-level definitions (extend Setup.definitions, overridden by source/destination definitions)"
        }
      },
      "oneOf": [
        { "required": ["web"], "not": { "required": ["server"] } },
        { "required": ["server"], "not": { "required": ["web"] } }
      ],
      "additionalProperties": false,
      "description": "Single flow configuration for one deployment target. Exactly one of 'web' or 'server' must be present."
    },
    "FlowSetup": {
      "type": "object",
      "properties": {
        "version": {
          "type": "integer",
          "const": 1,
          "description": "Configuration schema version (currently only 1 is supported)"
        },
        "$schema": {
          "type": "string",
          "format": "uri",
          "description": "JSON Schema reference for IDE validation (e.g., \"https://walkeros.io/schema/flow/v1.json\")"
        },
        "variables": {
          "$ref": "#/definitions/Variables",
          "description": "Shared variables for interpolation across all flows (use ${VAR_NAME} or ${VAR_NAME:default} syntax)"
        },
        "definitions": {
          "$ref": "#/definitions/Definitions",
          "description": "Reusable configuration definitions (reference with JSON Schema $ref syntax: { \"$ref\": \"#/definitions/name\" })"
        },
        "flows": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/FlowConfig"
          },
          "minProperties": 1,
          "description": "Named flow configurations (e.g., production, staging, development)"
        }
      },
      "required": ["version", "flows"],
      "additionalProperties": false,
      "description": "Complete multi-flow walkerOS configuration (walkeros.config.json)"
    }
  }
}
